下面是 **仅 macOS、功能尽量简洁** 的完整开发计划（Tauri），按“做完就能用”的顺序排好。

---
## 🤝 交互规则（MANDATORY）

> [!IMPORTANT]
> **这些规则必须严格遵守！**

1. **称呼规则**: 每次回复前必须使用"Yang"作为称呼
2. **决策确认**: 遇到不确定的代码设计问题时，必须先询问 Yang，不得直接行动
3. **代码兼容性**: 不能写兼容性代码，除非 Yang 主动要求。
4. 当我需要库/API 文档、代码生成、设置或配置步骤，而无需我明确提出要求时，我总是使用 Context7 MCP。
---

## 功能规格（MVP 只做这些）

1. **25 分钟专注**（Focus 25:00）
2. 每次专注结束 → **强制休息 5 分钟**（Short Break 5:00）

   * 进入休息后 **5 秒倒计时内触发锁屏**（例如第 0–5 秒内调用一次 lock）
   * 休息期若要**跳过**：必须点“跳过休息”→ 弹窗二次确认（默认按钮“继续休息”）
3. 每完成 **3 个番茄** → 下一次休息变为 **强制长休 25 分钟**（Long Break 25:00，同样规则：锁屏+可跳过需确认）

> 说明：macOS 无法在“系统解锁之前”弹自定义确认，但可以做到：锁屏→解锁回桌面后立刻弹出你的确认/倒计时窗口。

---

## 状态机设计（核心逻辑）

状态：

* `FOCUS`（25:00）
* `SHORT_BREAK`（5:00）
* `LONG_BREAK`（25:00）

规则：

* `FOCUS` 结束 → 如果已完成番茄数 +1 后 `count % 3 == 0` 则进入 `LONG_BREAK`，否则 `SHORT_BREAK`
* 进入任何 `BREAK`：

  * 立即开始倒计时
  * **启动 5 秒锁屏触发器**（只触发一次）
  * 展示 **BreakGuard**（强制休息窗口）
* 跳过休息：

  * 点击“跳过休息”→ 二次确认（确认后立刻进入 `FOCUS`，不补休）

---

## UI（最简两屏）

1. **主界面（菜单栏/小窗口都行）**

* 显示：当前状态 + 倒计时
* 按钮：开始 / 暂停（可选：只允许在 FOCUS 暂停）/ 重置（可选）

2. **BreakGuard 全屏遮罩**

* 文案：休息中 + 剩余时间
* 按钮：

  * **继续休息**（默认/主要）
  * **跳过休息** → 弹二次确认弹窗（确认/取消）

---

## macOS 系统能力（只实现两件）

### 1) 锁屏（一次性触发）

休息开始后 0–5 秒内调用一次：

* 执行：`CGSession -suspend`（通过 Rust `Command` 调用系统路径）

### 2) “解锁后拉回 BreakGuard”

MVP 先用**轮询**实现（最省坑）：

* 休息期间每 500ms～1s 检查一次：若桌面可见/应用非前台/窗口被隐藏 → 立刻 `show + focus` BreakGuard
* 目标：用户解锁回来后，马上被遮罩挡住

---

## 工程拆分（Tauri）

### Rust（src-tauri）

* `timer_engine.rs`

  * 计时 tick（1s）
  * 状态切换与番茄计数
  * 发事件给前端：`state_changed`, `tick`, `show_guard`
* `macos_lock.rs`

  * `lock_screen_once()`：进入 break 后 5 秒内只允许执行一次
* `guard_control.rs`

  * `show_guard() / focus_guard()`
  * （轮询任务）休息期确保 guard 在最前
* `storage.rs`（建议做，避免被绕）

  * 保存：当前状态、end_at、tomato_count、lock_called
  * 启动恢复：若处于 break 且未结束 → 直接 `show_guard`

### 前端（UI）

* `MainView`：展示状态/倒计时，发送开始/暂停/重置指令
* `BreakGuardView`：全屏遮罩 + 跳过确认弹窗

---

## 开发里程碑（按天/阶段验收）

### Milestone 1：状态机跑通（不锁屏也行）

* 能从 25:00 → 5:00 → 25:00 循环
* 番茄计数正确，每 3 个进 25 分钟长休

### Milestone 2：BreakGuard 全屏 + 跳过二次确认

* 休息时自动弹出遮罩
* 点“跳过休息”必须二次确认才能回到专注

### Milestone 3：休息开始 5 秒内锁屏

* 进入休息后 5 秒内锁屏触发一次
* 解锁回桌面后立刻出现 BreakGuard（靠轮询拉回）

### Milestone 4：持久化恢复（强烈建议）

* 强退/重启后如果休息未结束 → 自动继续休息并弹 Guard

---

## 验收清单（你可以照着逐条测试）

* [ ] 开始专注 25:00 正常倒计时
* [ ] 专注结束自动进入休息
* [ ] 进入休息后 5 秒内自动锁屏（只触发一次）
* [ ] 解锁后立即出现全屏休息遮罩
* [ ] 休息期间点“跳过休息”会弹二次确认；取消则继续休息
* [ ] 确认跳过后立刻回到专注
* [ ] 每完成 3 个番茄后，下一次休息为 25:00 长休
* [ ] （建议）重启应用后状态能恢复正确

---

如果你下一步要直接开工，我可以把 **Tauri 工程骨架（文件结构 + Rust 状态机接口 + 前端事件监听）**按这个计划写出来，你复制就能跑。你打算做成 **菜单栏常驻** 还是 **普通窗口应用**？（两者都能做，但菜单栏更符合“轻、但强制”。）
